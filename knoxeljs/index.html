<html>
<head>

<title> Knoxeljs </title>

<link rel="stylesheet" type="text/css" href="/css/style.css">

<!-- Embed the Javapoly code into this HTML page for future use (note that javapoly provides
       a JVM and Java compiler written in javascript that can run in the browser) -->
<script type="text/javascript" src="https://www.javapoly.com/javapoly.js"></script>

<!-- Embed the Turtle3D library in the HTML page so that we can use it to compile
       the in-page scripts written by the users. This works despite the fact that the
       library is written in Java because of JavaPoly -->
<script type="text/java" src="/java/lib/knoxeljs-0.2.jar"></script>

</head>

<body>

<ul class="tab">
  <li><a href="#" class="tablinks" id="javaTab" onclick="openTab(event, 'Java')">Java</a></li>
  <li><a href="#" class="tablinks" id="blocklyTab" onclick="openTab(event, 'Blockly')">Blockly</a></li>
  <li><a href="#" class="tablinks" id="gameTab" onclick="openTab(event, 'Game')">Game</a></li>
  <li><a href="#" class="tablinks" id="optionsTab" onclick="openTab(event, 'Options')">Options</a></li>
</ul>

<!-- All buttons' click action handlers are set in index.js -->

<div id="Java" class="tabcontent">
  <div id="sidebyside">
  <!-- <div id="tablerow"> -->
  <!-- This is the embedded IDE -->
  <div id="editor">// Do not remove the existing imports.

import org.knoxcraft.turtle3d.Turtle3D;
import static org.knoxcraft.turtle3d.KCTBlockTypes.*;

public class HelloWorld {
  public static void main(String[] args) {
    Turtle3D t=Turtle3D.createTurtle("myturtle");
    t.setBlock(RED_WOOL);
    t.forward(10);
  }
}
</div>

  <!-- This is the display for the different block types. It's filled in gameScript.js -->
  <div id="blocktypes"> </div>

</div>

<p>
  <button type="button" id="compileandrun">Compile code</button>
  <button type="button" id="downloadButton">Download code</button>
  <input type="file" id="codeUploadButton" class="inputfile">
  <label for="codeUploadButton">Upload code</label>
</p>

<div id="message">
  <br>
</div>

</div> <!-- End the Java Coding Tab Div-->

<div id="Blockly" class="tabcontent">
  <script src="/blockly-bundle.js"></script>
  <h1>Knoxcraft with Blockly!</h1>
  <p>Create your Knoxcraft Turtle scripts below.  For help and examples, see our Student Guide <a href="https://sites.google.com/a/knox.edu/knoxcraft/student-guide-blockly">here</a>.</p>

  <div>
    <p><button id="runblockly">Run this turtle in the Game window</button></p>
  </div>

  <div id="blocklyTable">
    <div id="blocklyArea">
    Blockly will be positioned here.
    </div>
  </div>

  <div id="blocklyDiv" style="position: absolute"></div>

  <!--Define the toolbox-->
  <xml id="toolbox" style="display: none">
   <category name="Turtle Commands" >
    <block type="turtle_init" gap="32"></block>
    <block type="turtle_move" gap="8"></block>
    <block type="turtle_turn" gap="32"></block>
    <block type="turtle_setblockplace" gap="32"></block>
    <block type="turtle_setblocktype2" gap="8"></block>
    <block type="turtle_setblocktype" gap="32"></block>
    <block type="turtle_setpos" gap="8"></block>
    <block type="turtle_setdir"></block>
    </category>
    <sep></sep>

    <category name="Text">
    <block type="text"></block>
    <block type="text_print"></block>
    <block type="text_append"></block>
    <block type="text_length"></block>
    <block type="text_isEmpty"></block>
    <block type="text_indexOf"></block>
    <block type="text_charAt"></block>
    <block type="text_getSubstring"></block>
    </category>

    <category name="Math">
    <block type="math_number"></block>
    <block type="math_arithmetic"></block>
    <block type="math_single"></block>
    <block type="math_trig"></block>
    <block type="math_constant"></block>
    <block type="math_number_property"></block>
    <block type="math_change"></block>
    <block type="math_round"></block>
    <block type="math_modulo"></block>
    <block type="math_random_int"></block>
    <block type="math_random_float"></block>
    </category>

    <category name="Control">
    <block type="controls_whileUntil"></block>
    <block type="controls_repeat_ext"></block>
    <block type="controls_for"></block>
    <block type="controls_flow_statements"></block>
    </category>

    <category name="Logic">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
    <block type="logic_operation"></block>
    <block type="logic_boolean"></block>
    <block type="logic_negate"></block>
    </category>

    <category name="Variables" custom="VARIABLE"></category>
    <category name="Functions" custom="PROCEDURE"></category>
  </xml>

  <script type="text/javascript">
  function removeFromDOMById(id){
    //http://stackoverflow.com/questions/3387427/remove-element-by-id
    var element = document.getElementById(id);
    if (element!=null){
      //console.log('removing outer html of '+id);
      element.outerHTML = "";
      delete element;
    }
  }
  function removeFromDOMByClass(clazz){
    var elements=document.getElementsByClassName(clazz);
    for (var i=0; i<elements.length; i++){
      var element=elements[i];
      //console.log('removing '+element);
      element.parentNode.removeChild(element);
    }
  }
  // TODO: figure out how to backup and restore the workspace
  var backupWorkspaceExists=false;
    // add handlers to the buttons we click to switch tabs
    var elements=document.getElementsByClassName('tablinks');
    for (var i=0; i<elements.length; i++){
      var elm=elements[i];
      elm.addEventListener('click', function(){
        // HACK
        var workspace = Blockly.getMainWorkspace();
        console.log('workspace is '+workspace);
        if (workspace != null) {
          var xml = Blockly.Xml.workspaceToDom(workspace);
          // Gets the current URL, not including the hash.
          var url = window.location.href.split('#')[0];
          window.localStorage.setItem(url, Blockly.Xml.domToText(xml));
          backupWorkspaceExists=true;
        }

        // HACK clearing out the blockly div and area,
        // and also removing DOMs that are added by
        // calls to Blockly.inject()
        // otherwise we leave a giant blockly tooltip div
        // sitting around in the other tabs

        //console.log('clearing blockly area and blockly div');

        document.getElementById('blocklyDiv').innerHTML='';
        document.getElementById('blocklyArea').innerHTML='';
        //removeFromDOMByClass('blocklyWidgetDiv');
        removeFromDOMByClass('blocklyToolboxDiv');
        //removeFromDOMByClass('blocklyTooltipDiv');

      });
      if (elm.id=='blocklyTab'){
        elm.addEventListener('click', function(){
          //console.log('hey-yo!');
          // we have to re-inject blockly each time for it to show up properly
          blocklySetup('blocklyArea', 'blocklyDiv', 'toolbox');
          console.log('backup workspace? '+backupWorkspaceExists);
          if (backupWorkspaceExists){
            window.setTimeout(BlocklyStorage.restoreBlocks, 0);
          }
          onresize();
        });
      }
    }

    // event handler to run the actual code
    document.getElementById('runblockly').addEventListener('click', function(){
      var code=runBlocklyCode();
      //knoxeljs.extractCommandsFromJSON(code);
      extractCommandsFromJSON(code);
    });
  </script>

</div>

<div id="Options" class="tabcontent">
  <p>Upload a Turtle3D JSON file (exported from BlueJay or Eclipse).</p>
  <div>
    <input type="file" id="JSONUploadButton" class="inputfile">
    <label for="JSONUploadButton">Choose a file</label>
  </div>

  <hr>

  <p>Override the automatic classname detector (useful for if you have multiple classes or commented-out classes):</p>
  <form action="#">
    Classname: <input type="text" id="classname"><br>
  </form>

  <hr>

  <form action="#">
    <input type="checkbox" id="clearMapBeforeScript">Clear the entire map when running a script<br>
    <input type="checkbox" id="autoRunScript" checked>Auto run scripts
  </form>

  <hr>

  <h3>Controls:</h3>
  <p>WASD to move</p>
  <p>SPACE to jump (Double tap to fly)</p>
  <p>SHIFT to fall when flying</p>
  <p>Look and click to set new script launch position</p>

</div>

<div id="Game" class="tabcontent">
  <div>
    <p>Script Status: <span id="scriptstatus">No script loaded</span></p>
    <button type="button" class="button" id="runscript">Run Current Script</button>
    <button type="button" id="undo">Undo Last Script</button>
    <p>Script Launch Location: <span id="looklocation">(0,0,0)</span></p>
  </div>
</div>

<!-- load code for the embedded ACE editor -->
<script src="/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
// setup the ACE editor
var editor = ace.edit("editor");
editor.setTheme("ace/theme/chrome");
editor.getSession().setMode("ace/mode/java");
editor.setAutoScrollEditorIntoView(true);
</script>

<!-- Script to manage tab logic-->
<script>
function openTab(evt, cityName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(cityName).style.display = "block";
    evt.currentTarget.className += " active";
}
</script>

<!-- Load the voxeljs code. Needs to be loaded after all the HTML stuff -->
<script src="/bundle.js"></script>


</body>
</html>
